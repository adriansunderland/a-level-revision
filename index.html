<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlotte's A-Level Revision App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .subject-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .subject-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .subject-btn.psychology {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }
        
        .subject-btn.pe {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: white;
        }
        
        .subject-btn.english {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .subject-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .subject-btn.active {
            ring: 4px solid white;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.5);
        }
        
        .topic-selector {
            margin-bottom: 20px;
        }
        
        .topic-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        
        .question-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }
        
        .question-box .marks {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .question-box .question-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
        }
        
        .answer-area {
            margin-bottom: 20px;
        }
        
        .answer-area label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .answer-area textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .answer-area textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .word-count {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .feedback-section {
            display: none;
        }
        
        .feedback-section.visible {
            display: block;
        }
        
        .mark-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }
        
        .mark-display .mark {
            font-size: 3em;
            font-weight: bold;
        }
        
        .mark-display .mark-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .grade-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .grade-a { background: #4CAF50; }
        .grade-b { background: #8BC34A; }
        .grade-c { background: #FFC107; color: #333; }
        .grade-d { background: #FF9800; }
        .grade-e { background: #f44336; }
        
        .feedback-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .feedback-box h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feedback-box.strengths {
            border-left: 4px solid #4CAF50;
        }
        
        .feedback-box.improvements {
            border-left: 4px solid #FF9800;
        }
        
        .feedback-box.model-points {
            border-left: 4px solid #2196F3;
        }
        
        .feedback-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .feedback-box p {
            line-height: 1.6;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .stat-item .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-item .stat-label {
            font-size: 0.85em;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        .mark-scheme-toggle {
            background: #e8f4fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            cursor: pointer;
        }
        
        .mark-scheme-toggle summary {
            font-weight: 600;
            color: #1976D2;
        }
        
        .mark-scheme-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #90caf9;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .api-key-section {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-key-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
            font-family: monospace;
        }

        .api-key-section small {
            color: #666;
            display: block;
            margin-top: 8px;
        }

        @media (max-width: 600px) {
            .subject-selector {
                flex-direction: column;
            }
            
            .subject-btn {
                width: 100%;
            }
            
            .stats-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Charlotte's A-Level Revision</h1>
            <p>Practice questions with AI-powered marking and feedback</p>
        </header>
        
        <!-- Stats Bar -->
        <div class="card">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="questionsAttempted">0</div>
                    <div class="stat-label">Questions Attempted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="averageMark">-</div>
                    <div class="stat-label">Average %</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">Day Streak üî•</div>
                </div>
            </div>
        </div>

        <!-- API Key Section -->
        <div class="card api-key-section" id="apiKeySection">
            <h3>üîë Setup: Enter Claude API Key</h3>
            <p style="margin-top: 10px; font-size: 0.95em;">To enable AI marking, you need a Claude API key. Get one free at <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></p>
            <input type="password" id="apiKey" placeholder="sk-ant-..." />
            <small>Your key is stored locally and never sent anywhere except Anthropic's API for marking.</small>
            <button class="btn-secondary" onclick="saveApiKey()" style="margin-top: 10px;">Save Key</button>
        </div>
        
        <!-- Question Section -->
        <div class="card" id="questionSection">
            <h2 style="margin-bottom: 20px;">üìù Practice Question</h2>
            
            <div class="subject-selector">
                <button class="subject-btn psychology active" onclick="selectSubject('psychology')">Psychology</button>
                <button class="subject-btn pe" onclick="selectSubject('pe')">PE</button>
                <button class="subject-btn english" onclick="selectSubject('english')">English</button>
            </div>
            
            <div class="topic-selector">
                <select id="topicSelect" onchange="loadQuestion()">
                    <option value="">Select a topic...</option>
                </select>
            </div>
            
            <div class="question-box" id="questionBox">
                <span class="marks" id="questionMarks">[4 marks]</span>
                <p class="question-text" id="questionText">Select a subject and topic to begin...</p>
            </div>
            
            <div class="answer-area">
                <label for="answerInput">Your Answer:</label>
                <textarea id="answerInput" placeholder="Type your answer here... Write as you would in an exam."></textarea>
                <div class="word-count"><span id="wordCount">0</span> words</div>
            </div>
            
            <button class="btn-primary" id="submitBtn" onclick="submitAnswer()">
                ‚ú® Mark My Answer
            </button>
            
            <button class="btn-secondary" onclick="skipQuestion()" style="width: 100%;">
                Skip ‚Üí Next Question
            </button>
        </div>
        
        <!-- Loading Section -->
        <div class="card hidden" id="loadingSection">
            <div class="loading">
                <div class="spinner"></div>
                <p>Analysing your answer...</p>
                <p style="color: #666; font-size: 0.9em;">Comparing against mark scheme criteria</p>
            </div>
        </div>
        
        <!-- Feedback Section -->
        <div class="card feedback-section" id="feedbackSection">
            <div class="mark-display">
                <div class="mark"><span id="markAwarded">0</span>/<span id="markTotal">4</span></div>
                <div class="mark-label">marks awarded</div>
                <div class="grade-indicator grade-a" id="gradeIndicator">Grade A Standard</div>
            </div>
            
            <div class="feedback-box strengths">
                <h3>‚úÖ What You Did Well</h3>
                <div id="strengthsFeedback"></div>
            </div>
            
            <div class="feedback-box improvements">
                <h3>üéØ How To Improve</h3>
                <div id="improvementsFeedback"></div>
            </div>
            
            <div class="feedback-box model-points">
                <h3>üí° Key Points You Could Add</h3>
                <div id="modelPointsFeedback"></div>
            </div>
            
            <details class="mark-scheme-toggle">
                <summary>üìã View Mark Scheme</summary>
                <div class="mark-scheme-content" id="markSchemeContent"></div>
            </details>
            
            <button class="btn-primary" onclick="nextQuestion()" style="margin-top: 20px;">
                Next Question ‚Üí
            </button>
        </div>
    </div>

    <script>
        // Question Bank
        const questionBank = {
            psychology: {
                'Biological Approach': [
                    {
                        question: "Outline two assumptions of the biological approach.",
                        marks: 4,
                        markScheme: "2 marks per assumption. Must identify assumption (1) and elaborate/exemplify (1). Valid assumptions: behaviour has genetic basis, neurochemistry affects behaviour, brain structure affects behaviour, evolution influences behaviour.",
                        modelAnswer: "One assumption is that behaviour has a genetic basis - characteristics can be inherited through genes, explaining why traits run in families. Twin studies support this. A second assumption is that neurochemistry affects behaviour - neurotransmitters like serotonin influence mood (low serotonin linked to depression)."
                    },
                    {
                        question: "Explain one strength and one weakness of drug therapy.",
                        marks: 4,
                        markScheme: "2 marks per point. Must identify strength/weakness (1) and elaborate with evidence or example (1).",
                        modelAnswer: "Strength: Research support - Kirsch et al.'s meta-analysis showed SSRIs effective for severe depression. Weakness: Side effects - SSRIs can cause nausea, insomnia, and increased suicidal thoughts in young people, raising ethical concerns."
                    },
                    {
                        question: "Evaluate the biological approach in psychology. [8 marks]",
                        marks: 8,
                        markScheme: "AO1 (2 marks): Brief description of approach. AO3 (6 marks): At least 2 strengths and 2 weaknesses with evidence. Top band requires comparison with other approaches.",
                        modelAnswer: "Strengths: Scientific methods (brain scans provide objective data - Raine et al. PET scans), practical applications (drug therapy). Weaknesses: Reductionist (ignores environment/cognition), deterministic (no free will - implications for responsibility). Unlike cognitive approach, focuses on biology not mental processes."
                    }
                ],
                'Cognitive Approach': [
                    {
                        question: "Describe the main features of CBT (Cognitive Behavioural Therapy).",
                        marks: 4,
                        markScheme: "1 mark per feature clearly described. Features include: identifying negative thoughts, challenging thoughts, developing alternatives, behavioural experiments, thought diaries, Socratic questioning.",
                        modelAnswer: "CBT identifies negative automatic thoughts using thought diaries. Thoughts are challenged through Socratic questioning ('What's the evidence?'). Clients develop more balanced alternative thoughts. Behavioural experiments test whether negative predictions come true."
                    },
                    {
                        question: "Evaluate CBT as a treatment for depression.",
                        marks: 6,
                        markScheme: "AO3: At least 2 strengths and 1 weakness OR 1 strength and 2 weaknesses. Must include research evidence for top marks. Consider effectiveness, suitability, comparison with alternatives.",
                        modelAnswer: "Strengths: NICE recommended, research support (Butler et al. meta-analysis showed large effect sizes), addresses cause not just symptoms. Weaknesses: Requires motivation (unsuitable for severe depression), time-consuming (6-20 sessions), may oversimplify - not all problems are cognitive."
                    }
                ],
                'Research Methods': [
                    {
                        question: "Explain the difference between reliability and validity.",
                        marks: 4,
                        markScheme: "2 marks per concept. Must define (1) and elaborate/exemplify (1). Reliability = consistency; Validity = measures what it claims to.",
                        modelAnswer: "Reliability refers to consistency - whether findings would be the same if the study were repeated. Validity refers to whether a study measures what it claims to measure. A study can be reliable but not valid (consistently measuring the wrong thing)."
                    },
                    {
                        question: "A researcher wants to study whether caffeine affects reaction time. Describe how they could design a laboratory experiment.",
                        marks: 6,
                        markScheme: "1 mark each for: appropriate design (independent groups/repeated measures with justification), clear IV and DV (operationalised), sampling method, standardised procedures, controls, ethical considerations.",
                        modelAnswer: "Use independent groups design (caffeine vs placebo) to avoid practice effects. IV: caffeine (200mg) vs placebo drink. DV: reaction time in milliseconds on computer task. Random allocation to conditions. Standardise: same time of day, same task, same instructions. Control caffeine intake beforehand. Informed consent, right to withdraw."
                    }
                ]
            },
            pe: {
                'Energy Systems': [
                    {
                        question: "Describe the ATP-PC system and explain when it is predominantly used.",
                        marks: 4,
                        markScheme: "Description (2): PC breakdown, creatine kinase enzyme, ATP resynthesis, anaerobic, 1 ATP yield. Application (2): duration (10 secs), intensity (maximal), sporting example.",
                        modelAnswer: "Phosphocreatine (PC) is broken down by creatine kinase to release energy for ATP resynthesis. It's anaerobic, produces 1 ATP per PC molecule, and has no fatiguing by-products. Predominantly used for high-intensity activities lasting up to 10 seconds, e.g., 100m sprint start, shot put, high jump take-off."
                    },
                    {
                        question: "Analyse the contribution of energy systems during a 400m race.",
                        marks: 8,
                        markScheme: "All three systems explained with timing. Application to 400m specifically. Understanding of energy continuum (systems work simultaneously). Reference to fatigue/lactic acid for top marks.",
                        modelAnswer: "ATP-PC dominant for first 100m (0-10s) during explosive acceleration. Anaerobic glycolytic becomes dominant from 100-350m as PC depletes - produces lactic acid causing 'tie-up' in final stages. Aerobic makes small contribution throughout (~15-20%) but cannot provide ATP fast enough for 400m pace. All three work simultaneously with varying dominance - energy continuum."
                    }
                ],
                'Biomechanics': [
                    {
                        question: "Using Newton's Laws, explain how a sprinter accelerates from the blocks.",
                        marks: 6,
                        markScheme: "2 marks per law: name law (1), apply to sprinter specifically (1). Must show understanding of how laws work together.",
                        modelAnswer: "1st Law (Inertia): Sprinter at rest stays at rest until force applied from pushing against blocks. 2nd Law (F=ma): Greater force against blocks = greater acceleration. More leg strength means faster start. 3rd Law: Push backwards against blocks (action), blocks push forward (reaction) propelling sprinter out."
                    },
                    {
                        question: "Explain how a diver controls their rate of rotation using angular momentum.",
                        marks: 4,
                        markScheme: "Define angular momentum (L=Iœâ). Explain conservation principle. Apply to tucking (decreases I, increases œâ) and extending (increases I, decreases œâ).",
                        modelAnswer: "Angular momentum (L=Iœâ) is conserved once diver leaves board. Tucking brings mass closer to axis of rotation, decreasing moment of inertia (I), so angular velocity (œâ) must increase to keep L constant - faster spin. Extending before entry increases I, decreases œâ for controlled entry."
                    }
                ],
                'Sport Psychology': [
                    {
                        question: "Describe Bandura's four sources of self-efficacy.",
                        marks: 4,
                        markScheme: "1 mark per source correctly identified and briefly explained. Sources: performance accomplishments, vicarious experience, verbal persuasion, emotional arousal.",
                        modelAnswer: "1. Performance accomplishments - past success (strongest source). 2. Vicarious experience - watching similar others succeed. 3. Verbal persuasion - encouragement from coaches/peers. 4. Emotional arousal - interpreting physical state (anxiety vs excitement)."
                    }
                ]
            },
            english: {
                'A Streetcar Named Desire': [
                    {
                        question: "Analyse how Williams uses light symbolism in 'A Streetcar Named Desire'.",
                        marks: 6,
                        markScheme: "AO2: Analysis of light/dark symbolism with specific examples. Must discuss: Blanche's aversion to light, paper lantern, connection to truth/illusion. AO3: Link to context (appearance vs reality theme) for top marks.",
                        modelAnswer: "Light symbolises truth and exposure - Blanche avoids bright light because it reveals her age and past. The paper lantern she places over the naked bulb represents her attempt to beautify harsh reality. Stage direction 'she winces' in bright light creates visual motif linking illumination with painful truth. Stanley's destruction of the lantern symbolically destroys her protective illusions."
                    },
                    {
                        question: "How does Williams present the conflict between Stanley and Blanche? [8 marks]",
                        marks: 8,
                        markScheme: "AO2: Analysis of dramatic techniques, language contrast, staging. AO3: Context (Old South vs New America, class conflict). Must discuss specific techniques with examples.",
                        modelAnswer: "Williams presents conflict through contrasting registers: Stanley's direct, colloquial language ('Meat!') versus Blanche's elaborate Southern rhetoric and euphemism. Dramatically, Stanley's physical presence dominates space while Blanche retreats. The conflict represents cultural clash between declining Old South (gentility, illusion) and New America (immigrant working-class, brutal honesty). Stage directions emphasise Stanley's animalistic qualities ('Tiger! Tiger!') against Blanche's fragility."
                    }
                ],
                'Things Fall Apart': [
                    {
                        question: "Analyse how Achebe uses narrative voice in 'Things Fall Apart'.",
                        marks: 6,
                        markScheme: "AO2: Analysis of third-person limited, free indirect discourse, incorporation of Igbo elements. Must discuss specific techniques with examples. AO3: Postcolonial context (reclaiming narrative voice) for top marks.",
                        modelAnswer: "Achebe uses third-person limited perspective aligned with Okonkwo, creating sympathy while maintaining critical distance during violence. Free indirect discourse ('His whole life was dominated by fear') reveals inner psychology. Igbo proverbs embedded throughout ('palm-oil with which words are eaten') validate oral tradition. The devastating shift to the Commissioner's perspective in the final chapter enacts colonial narrative violence - Okonkwo's life reduced to 'a reasonable paragraph'."
                    },
                    {
                        question: "How does Achebe present Okonkwo's tragic flaw?",
                        marks: 6,
                        markScheme: "AO2: Analysis of characterisation techniques. Must identify flaw (fear of weakness) and show how it's presented through narrative, action, language. AO3: Link to Igbo culture and colonial context.",
                        modelAnswer: "Okonkwo's tragic flaw is fear of weakness, explicitly stated through free indirect discourse: 'His whole life was dominated by fear, the fear of failure and of weakness.' This fear drives excessive aggression - beating his wife during the Week of Peace, killing Ikemefuna despite affection. Achebe presents this flaw as both personal tragedy and cultural critique - Okonkwo's rigid masculinity prevents adaptation to change, leading to his suicide when he cannot reconcile his values with colonial reality."
                    }
                ],
                'Literary Terminology': [
                    {
                        question: "Define 'semantic field' and 'foregrounding', giving examples of how writers use them.",
                        marks: 4,
                        markScheme: "2 marks per term: accurate definition (1) and clear example of usage (1).",
                        modelAnswer: "Semantic field: a group of words related in meaning. A writer might use a semantic field of war ('battle', 'fight', 'victory', 'defeat') to characterise a relationship as conflict. Foregrounding: making something stand out through deviation from expected patterns - unusual word order, repetition, or breaking conventions. E.g., the isolated short sentence 'Gone.' after long flowing sentences creates emphasis through structural deviation."
                    }
                ]
            }
        };

        // App State
        let currentSubject = 'psychology';
        let currentQuestion = null;
        let stats = {
            attempted: 0,
            totalMarks: 0,
            totalPossible: 0,
            lastAttemptDate: null
        };

        // Load stats from localStorage
        function loadStats() {
            const saved = localStorage.getItem('revisionStats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStatsDisplay();
            }
            
            // Check API key
            const apiKey = localStorage.getItem('claudeApiKey');
            if (apiKey) {
                document.getElementById('apiKeySection').style.display = 'none';
            }
        }

        function saveStats() {
            localStorage.setItem('revisionStats', JSON.stringify(stats));
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('questionsAttempted').textContent = stats.attempted;
            
            if (stats.totalPossible > 0) {
                const avg = Math.round((stats.totalMarks / stats.totalPossible) * 100);
                document.getElementById('averageMark').textContent = avg + '%';
            }
            
            // Calculate streak
            const today = new Date().toDateString();
            const lastDate = stats.lastAttemptDate;
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (lastDate === today) {
                // Already attempted today, keep streak
            } else if (lastDate === yesterday) {
                // Streak continues
            } else if (lastDate !== today) {
                // Streak broken (unless first attempt)
                if (stats.attempted > 0 && lastDate && lastDate !== today) {
                    stats.streak = 0;
                }
            }
            
            document.getElementById('streak').textContent = stats.streak || 0;
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key.startsWith('sk-ant-')) {
                localStorage.setItem('claudeApiKey', key);
                document.getElementById('apiKeySection').style.display = 'none';
                alert('API key saved! You can now use AI marking.');
            } else {
                alert('Please enter a valid Claude API key (starts with sk-ant-)');
            }
        }

        function selectSubject(subject) {
            currentSubject = subject;
            
            // Update button states
            document.querySelectorAll('.subject-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.subject-btn.${subject}`).classList.add('active');
            
            // Update topic dropdown
            const topicSelect = document.getElementById('topicSelect');
            topicSelect.innerHTML = '<option value="">Select a topic...</option>';
            
            const topics = Object.keys(questionBank[subject]);
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });
        }

        function loadQuestion() {
            const topic = document.getElementById('topicSelect').value;
            if (!topic) return;
            
            const questions = questionBank[currentSubject][topic];
            currentQuestion = questions[Math.floor(Math.random() * questions.length)];
            
            document.getElementById('questionMarks').textContent = `[${currentQuestion.marks} marks]`;
            document.getElementById('questionText').textContent = currentQuestion.question;
            document.getElementById('answerInput').value = '';
            document.getElementById('wordCount').textContent = '0';
            
            // Hide feedback, show question
            document.getElementById('feedbackSection').classList.remove('feedback-section');
            document.getElementById('feedbackSection').classList.add('hidden');
            document.getElementById('questionSection').classList.remove('hidden');
        }

        function skipQuestion() {
            loadQuestion();
        }

        // Word counter
        document.getElementById('answerInput').addEventListener('input', function() {
            const words = this.value.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('wordCount').textContent = words;
        });

        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            
            if (!answer) {
                alert('Please write an answer first!');
                return;
            }
            
            if (answer.split(/\s+/).length < 10) {
                alert('Your answer seems very short. Try to write more for better feedback!');
                return;
            }

            const apiKey = localStorage.getItem('claudeApiKey');
            
            // Show loading
            document.getElementById('questionSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            
            try {
                let feedback;
                
                if (apiKey) {
                    // Use real Claude API
                    feedback = await getAIFeedback(answer, apiKey);
                } else {
                    // Use simulated feedback
                    feedback = simulateFeedback(answer);
                }
                
                displayFeedback(feedback);
                
                // Update stats
                stats.attempted++;
                stats.totalMarks += feedback.mark;
                stats.totalPossible += currentQuestion.marks;
                stats.lastAttemptDate = new Date().toDateString();
                stats.streak = (stats.streak || 0) + 1;
                saveStats();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error getting feedback. Using offline mode.');
                const feedback = simulateFeedback(answer);
                displayFeedback(feedback);
            }
            
            // Hide loading, show feedback
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('feedbackSection').classList.remove('hidden');
            document.getElementById('feedbackSection').classList.add('feedback-section', 'visible');
        }

        async function getAIFeedback(answer, apiKey) {
            const prompt = `You are an experienced A-Level examiner marking a student's answer. Be encouraging but honest.

QUESTION: ${currentQuestion.question}
MARKS AVAILABLE: ${currentQuestion.marks}
MARK SCHEME: ${currentQuestion.markScheme}
MODEL ANSWER: ${currentQuestion.modelAnswer}

STUDENT'S ANSWER:
${answer}

Please mark this answer and provide feedback. Respond in this exact JSON format:
{
    "mark": <number between 0 and ${currentQuestion.marks}>,
    "strengths": ["strength 1", "strength 2"],
    "improvements": ["improvement 1", "improvement 2"],
    "missingPoints": ["key point they could add 1", "key point 2"],
    "overallComment": "Brief encouraging comment about their answer"
}

Be fair but rigorous. Award marks only for points that genuinely meet the mark scheme criteria. Identify specific strengths from their answer, specific areas for improvement, and key points from the mark scheme they missed.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1024,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }]
                })
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            const content = data.content[0].text;
            
            // Parse JSON from response
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
            throw new Error('Could not parse response');
        }

        function simulateFeedback(answer) {
            // Simple heuristic-based feedback when no API key
            const wordCount = answer.split(/\s+/).length;
            const hasEvidence = /research|study|found|showed|evidence/i.test(answer);
            const hasEvaluation = /however|strength|weakness|limitation|advantage|disadvantage/i.test(answer);
            const hasExamples = /example|for instance|such as|e\.g\./i.test(answer);
            
            let mark = 0;
            const maxMark = currentQuestion.marks;
            
            // Basic marking heuristics
            if (wordCount > 50) mark += maxMark * 0.2;
            if (wordCount > 100) mark += maxMark * 0.15;
            if (hasEvidence) mark += maxMark * 0.25;
            if (hasEvaluation) mark += maxMark * 0.25;
            if (hasExamples) mark += maxMark * 0.15;
            
            mark = Math.min(Math.round(mark), maxMark);
            
            const strengths = [];
            const improvements = [];
            
            if (wordCount > 80) strengths.push("Good level of detail in your response");
            if (hasEvidence) strengths.push("You included research evidence to support your points");
            if (hasEvaluation) strengths.push("You showed evaluation skills");
            if (hasExamples) strengths.push("Good use of examples");
            
            if (!hasEvidence) improvements.push("Include specific research evidence (researcher names, dates, findings)");
            if (!hasEvaluation) improvements.push("Add evaluation - discuss strengths and limitations");
            if (wordCount < 80) improvements.push("Develop your points with more detail");
            if (!hasExamples) improvements.push("Use specific examples to illustrate your points");
            
            return {
                mark: mark,
                strengths: strengths.length > 0 ? strengths : ["You attempted the question - keep practicing!"],
                improvements: improvements,
                missingPoints: ["Compare model answer below for key points to include"],
                overallComment: "Note: This is simplified feedback. Add your Claude API key for detailed AI marking!"
            };
        }

        function displayFeedback(feedback) {
            // Display mark
            document.getElementById('markAwarded').textContent = feedback.mark;
            document.getElementById('markTotal').textContent = currentQuestion.marks;
            
            // Calculate percentage and grade
            const percentage = (feedback.mark / currentQuestion.marks) * 100;
            const gradeIndicator = document.getElementById('gradeIndicator');
            gradeIndicator.className = 'grade-indicator';
            
            if (percentage >= 80) {
                gradeIndicator.textContent = 'Grade A Standard ‚≠ê';
                gradeIndicator.classList.add('grade-a');
            } else if (percentage >= 70) {
                gradeIndicator.textContent = 'Grade B Standard';
                gradeIndicator.classList.add('grade-b');
            } else if (percentage >= 60) {
                gradeIndicator.textContent = 'Grade C Standard';
                gradeIndicator.classList.add('grade-c');
            } else if (percentage >= 50) {
                gradeIndicator.textContent = 'Grade D Standard';
                gradeIndicator.classList.add('grade-d');
            } else {
                gradeIndicator.textContent = 'Needs Improvement';
                gradeIndicator.classList.add('grade-e');
            }
            
            // Display feedback sections
            document.getElementById('strengthsFeedback').innerHTML = 
                '<ul>' + feedback.strengths.map(s => `<li>${s}</li>`).join('') + '</ul>' +
                (feedback.overallComment ? `<p style="margin-top:10px;font-style:italic;">${feedback.overallComment}</p>` : '');
            
            document.getElementById('improvementsFeedback').innerHTML = 
                '<ul>' + feedback.improvements.map(i => `<li>${i}</li>`).join('') + '</ul>';
            
            document.getElementById('modelPointsFeedback').innerHTML = 
                '<ul>' + feedback.missingPoints.map(p => `<li>${p}</li>`).join('') + '</ul>';
            
            // Display mark scheme
            document.getElementById('markSchemeContent').innerHTML = 
                `<p><strong>Mark Scheme:</strong> ${currentQuestion.markScheme}</p>
                <p style="margin-top:10px;"><strong>Model Answer:</strong> ${currentQuestion.modelAnswer}</p>`;
        }

        function nextQuestion() {
            document.getElementById('feedbackSection').classList.remove('visible');
            document.getElementById('feedbackSection').classList.add('hidden');
            document.getElementById('questionSection').classList.remove('hidden');
            loadQuestion();
        }

        // Initialize
        loadStats();
        selectSubject('psychology');
    </script>
</body>
</html>
